[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [executing] maintenance: installing charm software
  untrusted-postgresql-k8s/1 [executing] blocked: Insufficient permissions, try: `juju trust untrusted-postgresql-k8s --scope=cluster`
  untrusted-postgresql-k8s/2 [executing] maintenance: installing charm software
[1m[31mERROR   [0m asyncio:base_events.py:1758 Task exception was never retrieved
future: <Task finished name='Task-210' coro=<Connection._connect.<locals>._try_endpoint() done, defined at /home/ubuntu/actions-runner/_work/test-runners-2-is-x64-postgresql-k8s-operator/test-runners-2-is-x64-postgresql-k8s-operator/.tox/integration/lib/python3.10/site-packages/juju/client/connection.py:803> exception=OSError(9, 'Bad file descriptor')>
Traceback (most recent call last):
  File "/home/ubuntu/actions-runner/_work/test-runners-2-is-x64-postgresql-k8s-operator/test-runners-2-is-x64-postgresql-k8s-operator/.tox/integration/lib/python3.10/site-packages/juju/client/connection.py", line 806, in _try_endpoint
    return await self._open(endpoint, cacert)
  File "/home/ubuntu/actions-runner/_work/test-runners-2-is-x64-postgresql-k8s-operator/test-runners-2-is-x64-postgresql-k8s-operator/.tox/integration/lib/python3.10/site-packages/juju/client/connection.py", line 427, in _open
    return (await websockets.connect(
  File "/home/ubuntu/actions-runner/_work/test-runners-2-is-x64-postgresql-k8s-operator/test-runners-2-is-x64-postgresql-k8s-operator/.tox/integration/lib/python3.10/site-packages/websockets/legacy/client.py", line 654, in __await_impl__
    _transport, protocol = await self._create_connection()
  File "/usr/lib/python3.10/asyncio/base_events.py", line 1103, in create_connection
    transport, protocol = await self._create_connection_transport(
  File "/usr/lib/python3.10/asyncio/base_events.py", line 1119, in _create_connection_transport
    sock.setblocking(False)
OSError: [Errno 9] Bad file descriptor
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [executing] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [executing] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] active: Primary
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/1 [idle] active: Primary
  untrusted-postgresql-k8s/2 [idle] waiting: awaiting for cluster to start
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/1 [idle] maintenance: reconfiguring cluster
  untrusted-postgresql-k8s/2 [idle] waiting: awaiting for cluster to start
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] waiting: awaiting for member to start
  untrusted-postgresql-k8s/1 [idle] active: Primary
  untrusted-postgresql-k8s/2 [idle] waiting: awaiting for cluster to start
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] waiting: awaiting for member to start
  untrusted-postgresql-k8s/1 [idle] active: Primary
  untrusted-postgresql-k8s/2 [idle] waiting: awaiting for member to start
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] active: 
  untrusted-postgresql-k8s/1 [idle] active: Primary
  untrusted-postgresql-k8s/2 [idle] waiting: awaiting for member to start
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] active: 
  untrusted-postgresql-k8s/1 [idle] active: Primary
  untrusted-postgresql-k8s/2 [idle] active:
[32mINFO    [0m pytest_operator.plugin:plugin.py:903 Model status:

Model  Controller          Cloud/Region        Version  SLA          Timestamp
test   microk8s-localhost  microk8s/localhost  3.4.5    unsupported  02:32:43Z

App                       Version  Status  Scale  Charm           Channel  Rev  Address        Exposed  Message
untrusted-postgresql-k8s  14.13    active      3  postgresql-k8s             0  10.152.183.43  no       

Unit                         Workload  Agent  Address     Ports  Message
untrusted-postgresql-k8s/0   active    idle   10.1.53.11         
untrusted-postgresql-k8s/1*  active    idle   10.1.53.12         Primary
untrusted-postgresql-k8s/2   active    idle   10.1.53.13         

[32mINFO    [0m pytest_operator.plugin:plugin.py:909 Juju error logs:

unit-untrusted-postgresql-k8s-1: 02:27:57 ERROR unit.untrusted-postgresql-k8s/1.juju-log 
            Access to k8s cluster resources is not authorized. This happens when RBAC is enabled and the deployed application was not trusted by the juju admin.
            To fix this issue, run `juju trust untrusted-postgresql-k8s --scope=cluster` (or remove & re-deploy untrusted-postgresql-k8s with `--trust`)
            
unit-untrusted-postgresql-k8s-1: 02:27:57 ERROR unit.untrusted-postgresql-k8s/1.juju-log 
            Access to k8s cluster resources is not authorized. This happens when RBAC is enabled and the deployed application was not trusted by the juju admin.
            To fix this issue, run `juju trust untrusted-postgresql-k8s --scope=cluster` (or remove & re-deploy untrusted-postgresql-k8s with `--trust`)
            
unit-untrusted-postgresql-k8s-0: 02:27:58 ERROR unit.untrusted-postgresql-k8s/0.juju-log Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/model.py", line 3213, in _run
    result = subprocess.run(args, **kwargs)  # type: ignore
  File "/usr/lib/python3.10/subprocess.py", line 526, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '('/var/lib/juju/tools/unit-untrusted-postgresql-k8s-0/secret-get', '--label', 'database-peers.untrusted-postgresql-k8s.app', '--format=json')' returned non-zero exit status 1.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/./src/charm.py", line 2202, in <module>
    main(PostgresqlOperatorCharm, use_juju_for_storage=True)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/main.py", line 553, in main
    manager.run()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/main.py", line 529, in run
    self._emit()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/main.py", line 518, in _emit
    _emit_charm_event(self.charm, self.dispatcher.event_name, self._juju_context)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/main.py", line 139, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/framework.py", line 347, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/framework.py", line 943, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/./src/charm.py", line 916, in _on_postgresql_pebble_ready
    self.unit.set_workload_version(self._patroni.rock_postgresql_version)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/./src/charm.py", line 1536, in _patroni
    self.get_secret(APP_SCOPE, REWIND_PASSWORD_KEY),
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/./src/charm.py", line 350, in get_secret
    return self.peer_relation_data(scope).get_secret(peers.id, secret_key)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 517, in wrapper
    return f(self, *args, **kwargs)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 2029, in get_secret
    and field not in self.current_secret_fields
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1985, in current_secret_fields
    if content := self._get_group_secret_contents(relation, group):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 2316, in _get_group_secret_contents
    result = super()._get_group_secret_contents(relation, group, secret_fields)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1119, in _get_group_secret_contents
    if (secret := self._get_relation_secret(relation.id, group)) and (
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 504, in wrapper
    return f(self, *args, **kwargs)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 2303, in _get_relation_secret
    return self.secrets.get(
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 808, in get
    if secret.meta:
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 638, in meta
    self._secret_meta = self._model.get_secret(label=self.label)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/model.py", line 299, in get_secret
    content = self._backend.secret_get(id=id, label=label)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/model.py", line 3579, in secret_get
    result = self._run('secret-get', *args, return_output=True, use_json=True)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/ops/model.py", line 3215, in _run
    raise ModelError(e.stderr) from e
ops.model.ModelError: ERROR permission denied

unit-untrusted-postgresql-k8s-0: 02:27:58 ERROR juju.worker.uniter.operation hook "postgresql-pebble-ready" (via hook dispatching script: dispatch) failed: exit status 1
unit-untrusted-postgresql-k8s-0: 02:27:58 ERROR juju.worker.uniter pebble poll failed for container "postgresql": failed to send pebble-ready event: hook failed

[32mINFO    [0m pytest_operator.plugin:plugin.py:991 Forgetting model main...