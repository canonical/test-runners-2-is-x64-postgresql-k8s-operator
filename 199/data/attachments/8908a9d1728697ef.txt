[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [executing] maintenance: installing charm software
  untrusted-postgresql-k8s/1 [executing] blocked: Insufficient permissions, try: `juju trust untrusted-postgresql-k8s --scope=cluster`
  untrusted-postgresql-k8s/2 [executing] maintenance: installing charm software
[31m[1mERROR   [0m asyncio:base_events.py:1758 Task exception was never retrieved
future: <Task finished name='Task-206' coro=<Connection._connect.<locals>._try_endpoint() done, defined at /home/ubuntu/actions-runner/_work/test-runners-2-is-x64-postgresql-k8s-operator/test-runners-2-is-x64-postgresql-k8s-operator/.tox/integration/lib/python3.10/site-packages/juju/client/connection.py:803> exception=OSError(9, 'Bad file descriptor')>
Traceback (most recent call last):
  File "/home/ubuntu/actions-runner/_work/test-runners-2-is-x64-postgresql-k8s-operator/test-runners-2-is-x64-postgresql-k8s-operator/.tox/integration/lib/python3.10/site-packages/juju/client/connection.py", line 806, in _try_endpoint
    return await self._open(endpoint, cacert)
  File "/home/ubuntu/actions-runner/_work/test-runners-2-is-x64-postgresql-k8s-operator/test-runners-2-is-x64-postgresql-k8s-operator/.tox/integration/lib/python3.10/site-packages/juju/client/connection.py", line 427, in _open
    return (await websockets.connect(
  File "/home/ubuntu/actions-runner/_work/test-runners-2-is-x64-postgresql-k8s-operator/test-runners-2-is-x64-postgresql-k8s-operator/.tox/integration/lib/python3.10/site-packages/websockets/legacy/client.py", line 654, in __await_impl__
    _transport, protocol = await self._create_connection()
  File "/usr/lib/python3.10/asyncio/base_events.py", line 1103, in create_connection
    transport, protocol = await self._create_connection_transport(
  File "/usr/lib/python3.10/asyncio/base_events.py", line 1119, in _create_connection_transport
    sock.setblocking(False)
OSError: [Errno 9] Bad file descriptor
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [executing] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [executing] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [idle] unknown:
[32mINFO    [0m pytest_operator.plugin:plugin.py:903 Model status:

Model  Controller          Cloud/Region        Version  SLA          Timestamp
test   microk8s-localhost  microk8s/localhost  3.4.5    unsupported  02:52:27Z

App                       Version  Status   Scale  Charm           Channel  Rev  Address         Exposed  Message
untrusted-postgresql-k8s  14.13    waiting      3  postgresql-k8s             0  10.152.183.177  no       installing agent

Unit                         Workload  Agent  Address     Ports  Message
untrusted-postgresql-k8s/0   unknown   idle   10.1.53.11         
untrusted-postgresql-k8s/1*  waiting   idle   10.1.53.13         awaiting for primary endpoint to be ready
untrusted-postgresql-k8s/2   unknown   idle   10.1.53.12         

[32mINFO    [0m pytest_operator.plugin:plugin.py:909 Juju error logs:

model-dba6d4a6-52f0-4ec9-80db-ca347d368cf5: 02:33:53 ERROR juju.kubernetes.klog /build/snapcraft-juju-8ec22e4f9d05626919bd46e16b741f52/parts/jujud/build/worker/caasrbacmapper/mapper.go:79: Failed to watch *v1.ServiceAccount: unknown (get serviceaccounts) - error from a previous attempt: read tcp 10.1.53.7:45556->10.152.183.1:443: read: connection reset by peer
unit-untrusted-postgresql-k8s-1: 02:35:46 ERROR unit.untrusted-postgresql-k8s/1.juju-log 
            Access to k8s cluster resources is not authorized. This happens when RBAC is enabled and the deployed application was not trusted by the juju admin.
            To fix this issue, run `juju trust untrusted-postgresql-k8s --scope=cluster` (or remove & re-deploy untrusted-postgresql-k8s with `--trust`)
            
unit-untrusted-postgresql-k8s-1: 02:35:46 ERROR unit.untrusted-postgresql-k8s/1.juju-log 
            Access to k8s cluster resources is not authorized. This happens when RBAC is enabled and the deployed application was not trusted by the juju admin.
            To fix this issue, run `juju trust untrusted-postgresql-k8s --scope=cluster` (or remove & re-deploy untrusted-postgresql-k8s with `--trust`)
            
unit-untrusted-postgresql-k8s-1: 02:35:48 ERROR unit.untrusted-postgresql-k8s/1.juju-log failed to create k8s services
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lightkube/core/generic_client.py", line 232, in raise_for_status
    resp.raise_for_status()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/httpx/_models.py", line 763, in raise_for_status
    raise HTTPStatusError(message, request=request, response=self)
httpx.HTTPStatusError: Client error '403 Forbidden' for url 'https://10.152.183.1/api/v1/namespaces/test/services/untrusted-postgresql-k8s-primary?force=true&fieldManager=untrusted-postgresql-k8s'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/./src/charm.py", line 1267, in _fix_pod
    self._create_services()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/./src/charm.py", line 1116, in _create_services
    client.apply(
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lightkube/core/client.py", line 754, in apply
    return self.patch(
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lightkube/core/client.py", line 489, in patch
    return self._client.request(
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lightkube/core/generic_client.py", line 308, in request
    return self.handle_response(method, resp, br)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lightkube/core/generic_client.py", line 248, in handle_response
    self.raise_for_status(resp)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lightkube/core/generic_client.py", line 234, in raise_for_status
    raise transform_exception(e)
lightkube.core.exceptions.ApiError: services "untrusted-postgresql-k8s-primary" is forbidden: 
unit-untrusted-postgresql-k8s-1: 02:35:48 ERROR unit.untrusted-postgresql-k8s/1.juju-log 
            Access to k8s cluster resources is not authorized. This happens when RBAC is enabled and the deployed application was not trusted by the juju admin.
            To fix this issue, run `juju trust untrusted-postgresql-k8s --scope=cluster` (or remove & re-deploy untrusted-postgresql-k8s with `--trust`)
            
unit-untrusted-postgresql-k8s-1: 02:35:49 ERROR unit.untrusted-postgresql-k8s/1.juju-log Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/./src/charm.py", line 2202, in <module>
    main(PostgresqlOperatorCharm, use_juju_for_storage=True)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/main.py", line 553, in main
    manager.run()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/main.py", line 529, in run
    self._emit()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/main.py", line 518, in _emit
    _emit_charm_event(self.charm, self.dispatcher.event_name, self._juju_context)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/main.py", line 139, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/framework.py", line 347, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/framework.py", line 943, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/./src/charm.py", line 940, in _on_postgresql_pebble_ready
    self._update_pebble_layers()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/./src/charm.py", line 1945, in _update_pebble_layers
    container.replan()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/model.py", line 2278, in replan
    self._pebble.replan_services()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/pebble.py", line 2131, in replan_services
    return self._services_action('replan', [], timeout, delay)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/ops/pebble.py", line 2228, in _services_action
    raise ChangeError(change.err, change)
ops.pebble.ChangeError: cannot perform the following tasks:
- Start service "postgresql" (cannot start service: exited quickly with code 1)
----- Logs from task 0 -----
2024-10-07T02:35:49Z INFO Most recent service output:
    Traceback (most recent call last):
      File "/usr/bin/patroni", line 33, in <module>
        sys.exit(load_entry_point('patroni==3.1.2', 'console_scripts', 'patroni')())
      File "/usr/lib/python3/dist-packages/patroni/__main__.py", line 196, in main
        return patroni_main(args.configfile)
      File "/usr/lib/python3/dist-packages/patroni/__main__.py", line 167, in patroni_main
        abstract_main(Patroni, configfile)
      File "/usr/lib/python3/dist-packages/patroni/daemon.py", line 172, in abstract_main
        controller = cls(config)
      File "/usr/lib/python3/dist-packages/patroni/__main__.py", line 40, in __init__
        self.postgresql = Postgresql(self.config['postgresql'])
      File "/usr/lib/python3/dist-packages/patroni/postgresql/__init__.py", line 69, in __init__
        self._data_dir: str = config['data_dir']
    KeyError: 'data_dir'
2024-10-07T02:35:49Z ERROR cannot start service: exited quickly with code 1
-----
unit-untrusted-postgresql-k8s-1: 02:35:50 ERROR juju.worker.uniter.operation hook "postgresql-pebble-ready" (via hook dispatching script: dispatch) failed: exit status 1
unit-untrusted-postgresql-k8s-1: 02:35:50 ERROR juju.worker.uniter pebble poll failed for container "postgresql": failed to send pebble-ready event: hook failed

[32mINFO    [0m pytest_operator.plugin:plugin.py:991 Forgetting model main...